<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>LipRead Analytics Report</title>
    <style>
        body { font-family: 'Inter','Helvetica','Arial',sans-serif; color: #1f2937; }
        .cover { text-align: center; padding: 120px 40px 80px; }
        .cover img { max-width: 180px; margin-bottom: 24px; }
        .title { font-size: 36px; font-weight: 700; margin-bottom: 8px; color: #0d6efd; }
        .subtitle { font-size: 18px; color: #6b7280; }
        .section { margin: 10mm 0; }
        .section h2 { font-size: 22px; margin-bottom: 4px; color: #0d6efd; }
        .section p { color: #4b5563; margin-top: 0; }
        .table { width: 100%; border-collapse: collapse; margin-top: 6px; }
        .table th, .table td { border: 1px solid #e5e7eb; padding: 8px; font-size: 12px; }
        .table th { background: #f8fafc; text-transform: uppercase; letter-spacing: .3px; color: #6b7280; }
        .divider { border-bottom: 1px solid #e5e7eb; margin: 8px 0 12px; }
        .toc { margin: 30px 0; }
        .toc li { margin-bottom: 6px; color: #374151; }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #e7f1ff; color: #0d6efd; font-size: 11px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .stat { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; }
        .stat .label { color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
        .stat .value { font-size: 18px; font-weight: 600; margin-top: 2px; }
        .bar { height: 8px; border-radius: 999px; background: linear-gradient(90deg, #0d6efd, #20c997); }
        footer { position: fixed; bottom: 12px; left: 0; right: 0; text-align: center; color: #6b7280; font-size: 10px; }
    </style>
</head>
<body>
    <div class="cover">
        <img src="{{ logo_path }}" alt="LipRead logo" />
        <div class="title">LipRead Analytics Report</div>
        <div class="subtitle">Generated {{ generated_at.strftime('%Y-%m-%d %H:%M UTC') }}</div>
    </div>

    <div class="section">
        <h2>Table of contents</h2>
        <div class="divider"></div>
        <ol class="toc">
            <li>User Analytics</li>
            <li>Course Analytics</li>
            <li>Subscription Analytics</li>
            <li>Revenue Analytics</li>
            <li>Transcription Analytics</li>
        </ol>
    </div>

    <div class="section">
        <h2>1. User Analytics</h2>
        <p>A snapshot of user growth, engagement, and learning momentum for the selected date range.</p>
        <div class="grid">
            <div class="stat"><div class="label">Total users</div><div class="value">{{ metrics.user.total_users }}</div></div>
            <div class="stat"><div class="label">Active users</div><div class="value">{{ metrics.user.active_users }}</div></div>
            <div class="stat"><div class="label">Average streak</div><div class="value">{{ metrics.user.avg_streak }} days</div></div>
            <div class="stat"><div class="label">Task completion</div><div class="value">{{ metrics.user.task_completion_rate }}%</div></div>
        </div>
        <table class="table" style="margin-top:12px;">
            <thead><tr><th>Month</th><th>New users</th></tr></thead>
            <tbody>
                {% for row in metrics.user.new_users_per_month %}
                <tr><td>{{ row.label }}</td><td>{{ row.count }}</td></tr>
                {% else %}
                <tr><td colspan="2">No new users recorded.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="divider"></div>
        <p class="label" style="color:#6b7280;">XP distribution</p>
        <table class="table">
            <thead><tr><th>Bucket</th><th>Users</th></tr></thead>
            <tbody>
                {% for row in metrics.user.xp_distribution %}
                <tr><td>{{ row.label }}</td><td>{{ row.count }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>2. Course Analytics</h2>
        <p>Course catalog health, premium coverage, and engagement across modules and lessons.</p>
        <div class="grid">
            <div class="stat"><div class="label">Courses</div><div class="value">{{ metrics.course.total_courses }}</div></div>
            <div class="stat"><div class="label">Modules</div><div class="value">{{ metrics.course.total_modules }}</div></div>
            <div class="stat"><div class="label">Lessons</div><div class="value">{{ metrics.course.total_lessons }}</div></div>
            <div class="stat"><div class="label">Premium courses</div><div class="value">{{ metrics.course.premium_courses }}</div></div>
        </div>
        <table class="table" style="margin-top:12px;">
            <thead><tr><th>Course</th><th>Enrolled</th><th>Completed</th></tr></thead>
            <tbody>
                {% for course in metrics.course.top_courses %}
                <tr><td>{{ course.title }}</td><td>{{ course.enrolled }}</td><td>{{ course.completed }}</td></tr>
                {% else %}
                <tr><td colspan="3">No course engagement data.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="divider"></div>
        <p style="margin-bottom:4px;">Activity completion heatmap (quiz/dictation/practice)</p>
        <table class="table">
            <thead><tr><th>Activity type</th><th>Completions</th></tr></thead>
            <tbody>
                {% for label, value in metrics.course.activity_heatmap.items() %}
                <tr><td>{{ label|title }}</td><td>{{ value }}</td></tr>
                {% else %}
                <tr><td colspan="2">No recorded activity attempts.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>3. Subscription Analytics</h2>
        <p>Conversion, retention, and plan-level subscription performance.</p>
        <div class="grid">
            <div class="stat"><div class="label">Total subscribers</div><div class="value">{{ metrics.subscription.total_subscribers }}</div></div>
            <div class="stat"><div class="label">Free â†’ Paid</div><div class="value">{{ metrics.subscription.free_to_paid_conversion }}%</div></div>
            <div class="stat"><div class="label">Trial conversion</div><div class="value">{{ metrics.subscription.trial_conversion }}%</div></div>
        </div>
        <table class="table" style="margin-top:12px;">
            <thead><tr><th>Plan</th><th>Active</th></tr></thead>
            <tbody>
                {% for plan in metrics.subscription.active_by_plan %}
                <tr><td>{{ plan.plan }}</td><td>{{ plan.count }}</td></tr>
                {% else %}
                <tr><td colspan="2">No active subscription plans.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="divider"></div>
        <p style="margin-bottom:4px;">Monthly new subscriptions</p>
        <table class="table">
            <thead><tr><th>Month</th><th>New subscriptions</th></tr></thead>
            <tbody>
                {% for row in metrics.subscription.monthly_new_subscriptions %}
                <tr><td>{{ row.label }}</td><td>{{ row.count }}</td></tr>
                {% else %}
                <tr><td colspan="2">No new subscriptions recorded.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>4. Revenue Analytics</h2>
        <p>Stripe-derived revenue, recurring momentum, and churn insights.</p>
        <div class="grid">
            <div class="stat"><div class="label">Total revenue (MYR)</div><div class="value">{{ format_currency(metrics.revenue.total_revenue) }}</div></div>
            <div class="stat"><div class="label">MRR</div><div class="value">{{ format_currency(metrics.revenue.mrr) }}</div></div>
            <div class="stat"><div class="label">ARPU</div><div class="value">{{ format_currency(metrics.revenue.arpu) }}</div></div>
            <div class="stat"><div class="label">Churn rate</div><div class="value">{{ metrics.revenue.churn_rate }}%</div></div>
        </div>
        <table class="table" style="margin-top:12px;">
            <thead><tr><th>Month</th><th>Revenue</th></tr></thead>
            <tbody>
                {% for row in metrics.revenue.monthly_revenue %}
                <tr><td>{{ row.label }}</td><td>{{ format_currency(row.amount) }}</td></tr>
                {% else %}
                <tr><td colspan="2">No revenue data.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>5. Transcription Analytics</h2>
        <p>Upload volume, per-user usage, and premium transcription adoption.</p>
        <div class="grid">
            <div class="stat"><div class="label">Total uploads</div><div class="value">{{ metrics.transcription.total_uploads }}</div></div>
            <div class="stat"><div class="label">Avg uploads per user</div><div class="value">{{ metrics.transcription.avg_uploads_per_user }}</div></div>
            <div class="stat"><div class="label">Users at limit</div><div class="value">{{ metrics.transcription.users_at_limit }}</div></div>
            <div class="stat"><div class="label">Premium usage</div><div class="value">{{ metrics.transcription.premium_usage }}</div></div>
        </div>
    </div>

    <div class="section" style="text-align:center; padding:40px 0;">
        <div class="title" style="font-size:24px;">End of Report</div>
        <p class="subtitle">Generated by LipRead Admin Panel</p>
    </div>

    <footer>Generated on {{ generated_at.strftime('%Y-%m-%d %H:%M UTC') }} by {{ admin_email }}</footer>
</body>
</html>