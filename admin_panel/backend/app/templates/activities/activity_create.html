{% extends "base.html" %}
{% block title %}Create Activity | LipRead Admin{% endblock %}
{% block header %}New Activity for {{ lesson.title if lesson else 'Lesson' }}{% endblock %}
{% block content %}
<div class="mb-3">
  <a class="text-decoration-none" href="/courses/{{ course.id }}/modules/{{ module.id }}/lessons/{{ lesson.id }}/activities">&larr; Back to activities</a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form id="activityForm" method="post" enctype="multipart/form-data" action="/courses/{{ course.id }}/modules/{{ module.id }}/lessons/{{ lesson.id }}/activities">
      <input type="hidden" name="payload" id="activityPayload">
      <div class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Title</label>
          <input class="form-control" id="activityTitle" name="title" placeholder="e.g. Mid-lesson quiz">
        </div>
        <div class="col-md-3">
          <label class="form-label">Type</label>
          <select class="form-select" id="activityType" name="type" required>
            <option value="quiz" selected>MCQ Quiz</option>
            <option value="dictation">Dictation</option>
            <option value="practice_lip">Practice</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Difficulty</label>
          <select class="form-select" id="activityDifficulty" name="difficultyLevel">
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Order</label>
          <input class="form-control" type="number" id="activityOrder" name="order" value="{{ next_order }}" min="0">
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">Scoring (activity level)</h6>
              <div class="input-group mb-2">
                <span class="input-group-text">Max</span>
                <input class="form-control" type="number" id="maxScore" name="maxScore" value="100" min="0">
                <span class="input-group-text">Pass</span>
                <input class="form-control" type="number" id="passingScore" name="passingScore" value="60" min="0">
              </div>
              <p class="text-muted small mb-0">Scoring is per activity, not per question.</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">Display</h6>
              <p class="text-muted small mb-0">Switch the activity type to reveal the correct fields below.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-3" id="mcqSection">
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Question Bank</h6>
              <span class="badge bg-primary">MCQ</span>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Bank title</label>
                <input class="form-control" id="bankTitle" name="bankTitle" placeholder="e.g. Unit 1 Quiz Bank">
              </div>
              <div class="col-md-6">
                <label class="form-label">Tags (comma separated)</label>
                <input class="form-control" id="bankTags" name="bankTags" placeholder="listening,phonetics">
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Description <span class="text-muted small">(optional)</span></label>
              <textarea class="form-control" id="bankDescription" name="bankDescription" rows="3" placeholder="Describe this question bank"></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">MCQ Questions</h6>
              <button class="btn btn-sm btn-outline-primary" type="button" id="addQuestionBtn">Add Question</button>
            </div>
            <div id="questionList" class="d-flex flex-column gap-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-none" id="dictationSection">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Dictation Items</h6>
              <button class="btn btn-sm btn-outline-primary" type="button" id="addDictationBtn">Add Dictation Item</button>
            </div>
            <div id="dictationList" class="d-flex flex-column gap-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-none" id="practiceSection">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Practice Items</h6>
              <button class="btn btn-sm btn-outline-primary" type="button" id="addPracticeBtn">Add Practice Item</button>
            </div>
            <div id="practiceList" class="d-flex flex-column gap-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Create activity</button>
      </div>
    </form>
  </div>
</div>

<template id="mcqTemplate">
  <div class="card border-1 mcq-question">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-semibold">Question <span class="question-index"></span></span>
        <button class="btn btn-sm btn-outline-danger remove-question" type="button">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Question stem</label>
        <textarea class="form-control question-stem" rows="2" placeholder="Enter the question"></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Options</label>
        <div class="option-list"></div>
        <button class="btn btn-sm btn-outline-secondary mt-2 add-option" type="button">Add another option</button>
        <div class="form-text">Use the radio selector to mark the correct option.</div>
      </div>
      <div class="row g-3">
        <div class="col-md-8">
          <label class="form-label">Question video <span class="text-muted small">(MP4, MOV, etc.)</span></label>
          <input class="form-control question-media" type="file" name="questionMedia" accept="video/*" required>
        </div>
      </div>
      <div class="mt-2">
        <label class="form-label">Explanation <span class="text-muted small">(optional)</span></label>
        <textarea class="form-control question-explanation" rows="2"></textarea>
      </div>
    </div>
  </div>
</template>

<template id="dictationTemplate">
  <div class="card border-1 dictation-item">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-semibold">Dictation Item <span class="dictation-index"></span></span>
        <button class="btn btn-sm btn-outline-danger remove-dictation" type="button">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Correct text</label>
        <textarea class="form-control dictation-correct" rows="2" placeholder="Type the correct transcript" required></textarea>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Dictation video</label>
          <input class="form-control dictation-media" type="file" name="dictationMedia" accept="video/*" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Hints <span class="text-muted small">(optional)</span></label>
          <input class="form-control dictation-hints" placeholder="Example: focus on consonants">
        </div>
      </div>
    </div>
  </div>
</template>

<template id="practiceTemplate">
  <div class="card border-1 practice-item">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-semibold">Practice Item <span class="practice-index"></span></span>
        <button class="btn btn-sm btn-outline-danger remove-practice" type="button">Remove</button>
      </div>
      <div class="mb-2">
        <label class="form-label">Prompt / Description</label>
        <textarea class="form-control practice-description" rows="2" placeholder="Describe what the learner should practice" required></textarea>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Target word or phrase <span class="text-muted small">(optional)</span></label>
          <input class="form-control practice-target" placeholder="e.g. Lip reading">
        </div>
        <div class="col-md-6">
          <label class="form-label">Practice video</label>
          <input class="form-control practice-media" type="file" name="practiceMedia" accept="video/*" required>
        </div>
      </div>
    </div>
  </div>
</template>
<script src="/static/js/activity-form.js"></script>
<script>
  initActivityForm({
    initialData: {
      title: '',
      type: 'quiz',
      order: {{ next_order }},
      difficultyLevel: 'beginner',
      scoring: { maxScore: 100, passingScore: 60 },
      questionBank: { title: '', difficulty: 1, tags: [], description: '' },
      questions: [],
      dictationItems: [],
      practiceItems: [],
    },
  });
</script>
{% endblock %}
